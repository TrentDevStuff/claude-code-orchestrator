---
created: 2026-02-25T22:00:00Z
updated: 2026-02-26T00:30:00Z
ai_last_processed: 2026-02-25T22:00:00Z
type: project-daily
project: PROJECT-Claude-Code-API-Service
---

# 2026-02-25 -- Daily Log

## Session Summary

**Session 1:** Investigated latency complaints from downstream AI services. Created EFFORT-Latency-Optimization with extended thinking root cause analysis. Created API key for ai-rag-services and identified /v1/process auth issue.

**Session 2:** Implemented all latency fixes (P0-P2) in commit 9172061 (228 tests passing). Then made SDK the default execution path for `/v1/process` — renamed `use_sdk` to `use_cli` with inverted default. Updated all documentation (ARCHITECTURE, API_REFERENCE, completions, agentic-tasks) and created new execution-paths guide.

## Work Done Today

### Latency Root Cause Analysis (EFFORT-Latency-Optimization)

Downstream AIs reported 5-15 seconds of latency per call. Used extended thinking analysis of the full request pipeline. Found **~5,500ms of overhead** (before Claude API inference even starts).

**Three critical bottlenecks identified:**

| # | Bottleneck | Latency | Location |
|---|-----------|---------|----------|
| 1 | **Claude CLI cold start** — every request spawns a new `claude` process via `subprocess.Popen(shell=True)` | 3,000-8,000ms | `worker_pool.py:412` |
| 2 | **Event loop blocking** — `/v1/process` calls `get_result()` synchronously, blocking asyncio event loop for 10-30s. Serializes all concurrent requests. | 0-5,000ms stall | `api.py:546` |
| 3 | **Monitor loop polling** — 500ms queue pickup + 100ms sleep cycles compound to 200-1000ms added latency | 0-600ms | `worker_pool.py:342-359` |

**Fix plan created (P0-P3):**
- **P0 (5 min):** Wrap `get_result()` in `run_in_executor` at `/v1/process` — eliminates serialization
- **P1a (30 min):** Replace polling with `threading.Event` — sub-ms notification
- **P1b (20 min):** Direct task start in `submit()` — bypass queue delay
- **P2 (2-4 hrs):** Optional Anthropic SDK direct path for simple completions
- **P3 (30 min):** SQLite connection pooling

### API Key for ai-rag-services

Created enterprise key: `cc_7877f4b548c2b4855f52afbe7cde129a46e2745b` (1000 req/min, all permissions). Revoked an earlier accidental key. CLI has Python 3.9 compat issue (`str | None` syntax).

### Identified: /v1/process Auth Issue

ai-rag-services gets 500 "Internal error during authentication" — traced to `src/auth.py:336` (`auth_manager` is `None`). Related to EFFORT-Compatibility-Adapter scope. Not yet fixed.

### Latency Fixes Implemented (commit 9172061)

All P0-P2 fixes implemented and tested (228 tests passing):
- **P0:** Wrapped `get_result()` in `run_in_executor` — eliminated event loop blocking
- **P1a:** Replaced polling with `threading.Event` — sub-ms completion notification
- **P1b:** Direct task start in `submit()` — bypassed queue delay
- **P2:** Anthropic SDK direct path via `src/direct_completion.py` — eliminates 3-8s CLI cold start

### SDK Default Flip (post-9172061)

Made SDK the default execution path for `/v1/process`:
- Renamed `use_sdk: bool = False` → `use_cli: bool = False` in `ProcessRequest`
- Inverted routing logic: SDK is default, CLI is opt-in
- Most downstream callers only need simple completions — no CLI features needed

### Documentation Overhaul

Updated all docs to reflect dual execution paths, new endpoints, and latency optimizations:
- **ARCHITECTURE.md** — Added DirectCompletionClient to diagram, dual execution path section, updated latency numbers, updated data flow
- **API_REFERENCE.md** — Added `/v1/process`, `/v1/task`, `/v1/capabilities`, `/v1/providers` endpoints (was missing 5 endpoints)
- **completions.md** — Added execution path context
- **agentic-tasks.md** — Added CLI-always note
- **New: guides/execution-paths.md** — SDK vs CLI decision tree, latency comparison, migration guide

## Leaving Off / Pick Up Tomorrow

### Priority 1: Debug /v1/process auth 500 error

- Why is `auth_manager` None when `/v1/process` processes requests?
- Check if `/v1/process` route goes through same auth dependency as other endpoints
- Test with exact payload ai-rag-services sends

### Priority 2: Close remaining efforts

- EFFORT-Production-Hardening (95%) — verify CI passes
- EFFORT-MCP-Tool-Routing (85%) — permission profiles for MCP tools

### Priority 3: P3 SQLite connection pooling

- Low priority (~5-10ms savings)
- Keep persistent SQLite connection with WAL mode

## Effort Status Snapshot

| Effort | Status | Progress | Notes |
|--------|--------|----------|-------|
| **Latency-Optimization** | in_progress | 85% | P0-P2 done, SDK default, docs updated. P3 remaining (low priority) |
| Production-Hardening | in_progress | 95% | Just needs CI verification |
| MCP-Tool-Routing | in_progress | 85% | Permission profiles remaining |
| Compatibility-Adapter | planning | 0% | Auth 500 error is trigger to start |
| Agent-Discovery Phase 2-5 | not_started | 0% | Low priority |
